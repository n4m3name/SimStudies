---
title: "Simulation Study: One-Sample t-test + eJAB Diagnostic"
author: "Evan Strasdin"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    theme: flatly
---

# 1. Objective

We study the **Bayes–frequentist conflict diagnostic** for a **one-sample t-test**:
flag a conflict when the result is **significant** ($p \le \alpha$) **and** the approximate Bayes factor **favors** $H_0$ ($eJAB_{01} > 1$).
We examine how this behaves as **sample size $n$** and **effect size** change.

---

# 2. eJAB formula (for one parameter, $q=1$)

$$
eJAB_{01}
= \sqrt{n}\,
\exp\!\left(
-\frac{1}{2}\, Q_{\chi^2_1}(1-p)\, \frac{n-1}{n}
\right),
\quad
eJAB_{10} = \frac{1}{eJAB_{01}}.
$$

- $p$ is the p-value from the t-test.  
- $Q_{\chi^2_1}$ is the $\chi^2$ quantile with 1 df.  
- $n$ is the (effective) sample size.  
- **Decision**: $eJAB_{01} > 1$ favors $H_0$; $eJAB_{01} < 1$ favors $H_1$.

---

# 3. Simulation design

We simulate Normal data with **Cohen’s $d$** effect sizes. If $ES$ is Cohen’s $d$ and population SD is $\sigma$,
the population mean is $\mu = ES \cdot \sigma$.

```{r setup, message=FALSE, warning=FALSE}
set.seed(277)

# one-sample generator + diagnostic outputs
typeIerr_t <- function(N, ES, SD) {
  # ES is Cohen's d; data have mean = ES*SD and sd = SD
  x <- rnorm(N, mean = ES, sd = 1) * SD  # equivalent to mean = ES*SD, sd = SD
  
  # one-sample t-test against mu=0
  pVal <- t.test(x)$p.value
  
  # eJAB_01 for q = 1
  eJAB01 <- sqrt(N) * exp(-0.5 * qchisq(1 - pVal, df = 1) * (N - 1) / N)
  
  c("N" = N, "ES" = ES, "SD" = SD, "pVal" = pVal, "eJAB01" = eJAB01)
}

# Grid / draws
NSim   <- 7e4                   # total replications
myES   <- c(0, 0.2, 0.5, 0.8)   # Cohen's d: null, small, medium, large
mySize <- c(10, 20, 50, 100, 200)
mySD   <- c(1, 2, 4)

# Run simulations
df <- t(replicate(
  NSim,
  typeIerr_t(
    sample(mySize, 1),
    sample(myES,  1),
    sample(mySD,  1)
  )
))
df <- data.frame(df)

# Ensure numeric types (replicate() returns character cols)
num_cols <- c("N","ES","SD","pVal","eJAB01")
df[num_cols] <- lapply(df[num_cols], as.numeric)
```

---

# 4. Diagnostic curves (conflict rate vs $\\alpha$)

We compute:

- **Observed conflict rate:**  
  $\\Pr(p \\le \\alpha,\\ eJAB_{01} > 1)$ (denominator = all simulations).

- **True type I error rate (under $ES=0$):**  
  $\\Pr(p \\le \\alpha \\mid ES = 0)$ (denominator = simulations with $ES=0$).

We expect the observed conflict curve to track the **45° line** ($y=x$) when the **null proportion is high**.

```{r curves, message=FALSE, warning=FALSE}
threshold <- seq(0, 1, length.out = 500)

# Counts across all sims
count_conflict <- sapply(threshold, function(a)
  nrow(subset(df, pVal <= a & eJAB01 > 1)))

# True type I among null sims
df0 <- subset(df, ES == 0)
count_true_type1 <- sapply(threshold, function(a)
  nrow(subset(df0, pVal <= a)))

plot(threshold, count_conflict / nrow(df),
     type = "l", lwd = 2, col = "#1f77b4",
     xlab = expression(alpha),
     ylab = "Rate",
     main = expression("Observed conflict vs. significance level  " * (p <= alpha ~ " & " ~ eJAB[01] > 1)))
lines(threshold, count_true_type1 / nrow(df0), col = "red", lwd = 2)
abline(a = 0, b = 1, lty = 3, lwd = 2)
legend("topleft",
       legend = c("Observed conflict", "True type I (ES=0)", "y = x"),
       col = c("#1f77b4", "red", "black"),
       lwd = c(2, 2, 2),
       lty = c(1, 1, 3))
```

---

# 5. Sensitivity and precision at $\\alpha=0.05$

Definitions:

$$
\text{Sensitivity}
= \frac{\#\{p \le \alpha,\ eJAB_{01} > 1,\ ES = 0\}}
       {\#\{p \le \alpha,\ ES = 0\}},
\quad
\text{Precision}
= \frac{\#\{p \le \alpha,\ eJAB_{01} > 1,\ ES = 0\}}
       {\#\{p \le \alpha,\ eJAB_{01} > 1\}}.
$$


```{r sens-prec, message=FALSE, warning=FALSE}
alpha <- 0.05
hit        <- nrow(subset(df, pVal <= alpha & eJAB01 > 1 & ES == 0))
den_sens   <- nrow(subset(df, pVal <= alpha & ES == 0))
den_prec   <- nrow(subset(df, pVal <= alpha & eJAB01 > 1))

sensitivity <- ifelse(den_sens > 0, hit / den_sens, NA_real_)
precision   <- ifelse(den_prec > 0, hit / den_prec, NA_real_)

cat("Sensitivity:", round(sensitivity, 3), "\\n")
cat("Precision:",   round(precision,   3), "\\n")
```

---

# 6. Interpretation

- When the proportion of true nulls is high, the observed proportion of $(p \le \alpha,\ eJAB_{01} > 1)$ tracks $y = x$, confirming that the diagnostic correctly identifies **candidate type I errors**.
- As $n$ increases, both **sensitivity** and **precision** should approach 1, consistent with the **model-selection consistency** property of $eJAB$.


---

# 7. Next steps

- Add **sensitivity/precision vs $n$** plots.
- Introduce **ROC curves** (varying effect size).  
- Stratify results by $(n, ES)$ for detailed diagnostics.
